{% extends "network/layout.html" %}

{% block body %}
    <div class="container-fluid" id="root"> 
    </div>

    <script type="text/babel">
        function FollowingView(props){
            const [data, setData] = React.useState(null)

            React.useEffect(()=> {
                fetch('following_posts')
                .then(response => response.json())
                .then(posts => {
                    posts.posts.map(post => post.liked_by.includes("{{user.username}}") ? post.like = false : post.like = true )
                    setData(posts.posts)
                    props.setUpdate(true)})
            }, [props.update])

            console.log(data)
            return <div className="container-fluid">
                        <h1>Your Feed</h1>
                        {data &&  data.map(({like, id, posted_by, content, posted_at, liked_by}) => (
                                <div className="card">
                                        <div className="card-header">
                                            <h5><button id="user_button" onClick={()=>props.profile(posted_by)}>{posted_by}</button></h5>
                                            <div className='buttons' user="{{user.username}}">
                                                <LikeButtons id={id} liked_by={liked_by} like={like} posted_by={posted_by} setUpdate={props.setUpdate} func={changeButton}/>
                                            </div>
                                        </div>
                                        <div className="card-body">
                                            <p className="card-text">{content}</p>
                                            <WhoLiked liked_by={liked_by} />
                                        </div>
                                        <div className="card-footer text-muted">{posted_at}</div>
                                    </div>
                                ))}
                            </div>; 
        }

        function FollowButton(props){
            const [isFollowed, setIsFollowed] = React.useState(props.followers.includes("{{user.username}}") ? true : false)
            
            function followAction(){
                fetch('follow',{
                    method:'PUT',
                    body:JSON.stringify({
                        target:props.user
                    })
                })
                .then(response=> response.json())
                .then(message => {message.error? alert(message.error) : alert(message.following)})  
                setIsFollowed(prevIsFollowed => !prevIsFollowed)  
                props.update(false)             
            }
            return <button id="followbutton" onClick={()=>followAction()}>{isFollowed ? 'Unfollow' : 'Follow'}</button>
        
        }

        function UserView(props){
            const [data, setData] = React.useState(null)
            const [updateF, setUpdateF] = React.useState(null)
            const [error, setError] = React.useState(null)

            React.useEffect(()=>{
                fetch(`user_profile/${props.user}`)
                .then(response => response.json())
                .then(userInfo => {
                    userInfo.posts.map(post => post.liked_by.includes("{{user.username}}") ? post.like = false : post.like = true )
                    props.setUpdate(true)
                    setData(userInfo), 
                    setUpdateF(true)})
                .catch(err => {
                    setError(err.message)
                    setData(null)
                })
                return {}
            },[props.user, updateF, props.update])
            
            return (data &&  
                (<div class="container-fluid" id="profile"> 
                    <div class="row align-items-center">
                        <div class="col" id="name">
                            <img src="https://st3.depositphotos.com/6672868/13701/v/380/depositphotos_137014128-stock-illustration-user-profile-icon.jpg?forcejpeg=true" height="200" alt="profile placeholder"></img>
                        </div>
                        <div class="col " id="info">
                            <div class="row text-center" id="user">{props.user}</div>
                            <div class="row" id="following">Following: {data.following.length}</div>
                            <div class="row" id="followers">Followers: {data.followers.length}</div>
                            <div class="row " id="postings">Postings: {data.posts.length}</div>
                            {props.user !== "{{user.username}}" && <FollowButton user={props.user} followers={data.followers} update={setUpdateF}/>}
                        </div>
                    </div>
                    <h1>{props.user}'s Posts</h1>
                    {data.posts.map(({like, id, posted_by, content, posted_at, liked_by})=> (
                        <div className="card">
                            <div className="card-header">
                                <h5>{posted_by}</h5>
                                <div className='buttons' user="{{user.username}}">
                                    {posted_by != "{{user.username}}" && <LikeButtons id={id} liked_by={liked_by} like={like} posted_by={posted_by} setUpdate={props.setUpdate} func={changeButton}/>}
                                </div>
                            </div>
                            <div className="card-body">
                                <p className="card-text">{content}</p>
                                <WhoLiked liked_by={liked_by} />
                            </div>
                            <div className="card-footer text-muted">{posted_at}</div>
                        </div>
                    ))}
                    <Pagination fetchOn={`user_profile/${props.user}`} setData={setData} setError={setError} setUpdate={props.setUpdate}/> /* FIXME */
                </div>)
            )    
        }
        
        function Home(){
            return (
                <div className="home">
                    <img src="https://miro.medium.com/max/1200/1*nm4VZt2HpZj0CW3FL3b-eg.png"/>
                </div>
            )    
        }

        function PostForm(props){
            const [formData, setformData] = React.useState({
                posted_by: "{{user.username}}",
                content: ""
            })
            
            function handleInputChange(event){
                const {value} = event.target
                setformData(prevFormData => {
                    return {...prevFormData, content: value}
                })
            };

            function handleSubmit(event){
                event.preventDefault()
                fetch('all_posts',{
                    method:'POST',
                    body: JSON.stringify(formData)
                })
                props.setUpdate(false)
                props.setShowPosts(true)
                  
            }

            return ( 
                <div className="container-fluid" id="title"> 
                    <h1>Welcome to the Network <b>{"{{user.username}}"}</b>!!</h1>
                    <form className="form-row" onSubmit={handleSubmit}>
                        <div className="form-group col mb-2">
                            <input onChange={handleInputChange} className="form-control" placeholder="What's Poppin?!" id="post_content" name="content"></input>
                        </div>
                        <button className="btn btn-primary mb-2 mx-2 col-1" id="post_button">Post</button>   
                    </form>
                </div>
            )
        }

        function WhoLiked(props){
            let string = 'Nobody liked this yet'

            if(props.liked_by.length>0){
                        if (props.liked_by.length >=3){
                            string = `${props.liked_by[0]}, ${props.liked_by[1]} and ${props.liked_by.length-2} more liked this.`
                        } else if (props.liked_by.length>1){
                            string = `${props.liked_by[0]} and ${props.liked_by[1]} liked this.` 
                        } else if (props.liked_by.length=1){
                            string = `${props.liked_by[0]} liked this.`
                        } 
                    }
            return <div className="text-muted">{string}</div>
        }

        function LikeButtons(props){
            return (
                props.like ? 
                    <button key={props.id} id={props.id} className="btn btn-success" onClick={()=>{props.func(props.id, props.posted_by, props.liked_by, props.setUpdate)}}>Like</button> :
                    <button key={props.id} id={props.id} className="btn btn-danger" onClick={()=>{props.func(props.id, props.posted_by, props.liked_by, props.setUpdate)}}>Dislike</button>
            )
        }

        function changeButton(id, posted_by, liked_by, setUpdate){
                // Only do actions if the post is not posted by user logged in
                if("{{user.username}}"===posted_by){
                    alert(`You cannot like your post!`)

                } else {
                    fetch('all_posts', {
                        method:'PUT',
                        body:JSON.stringify({
                        user:"{{user.username}}",
                        post:id,
                        })
                    })
                };
                setUpdate(false)
            } 
        
        function Pagination(props){
            const [hasPrevious, setHasPrevious] = React.useState(false)
            const [hasNext, setHasNext] = React.useState(true)
            const [currentPage, setCurrentPage] = React.useState(1)
            
            function pagination(page){
                fetch(`${props.fetchOn}?page=${page}`) 
                .then(response => {
                    if (!response.ok){
                        throw new Error(`HTTP Error Status ${response.status}`)
                    };
                    return response.json()
                })
                .then(posts => {
                    Array.isArray(posts) ?
                    posts.map(post => post.liked_by.includes("{{user.username}}") ? post.like = false : post.like = true )
                    : posts.posts.map(post => post.liked_by.includes("{{user.username}}") ? post.like = false : post.like = true)
                    props.setData(posts)
                    props.setUpdate(true)    
                })
                .catch(err => {
                    props.setError(err.message)
                    props.setData(null)
                })
                setCurrentPage(page)
                page > 1 ? setHasPrevious(true) : setHasPrevious(false)
                "{{pagination.paginator.num_pages}}" > 1 && page < "{{pagination.paginator.num_pages}}" ? setHasNext(true):setHasNext(false)
            }

            function PaginationLinks(){
                const page=[]
                for (let i=1; i<= "{{pagination.paginator.num_pages}}"; i++){
                    page.push(<li class="page-item"><a class="page-link" onClick={()=> pagination(i)}>{i}</a></li>)
                }
                return page.map(li => li)         
            }
            return  <nav>
                        <ul class="pagination">
                            {hasPrevious && <li class="page-item"><a class="page-link" onClick={()=> pagination(currentPage-1)}>Previous</a></li>}
                            <PaginationLinks/>
                            {hasNext && <li class="page-item"><a class="page-link" onClick={()=> pagination(currentPage+1)}>Next</a></li>}
                        </ul>
                    </nav>
        }

        function Posts (props) {
            const [data, setData] = React.useState(null);
            const [error, setError] = React.useState(null);
            
            React.useEffect(() => {
                fetch('all_posts')
                .then(response => {
                    if (!response.ok){
                        throw new Error(`HTTP Error Status ${response.status}`)
                    };
                    return response.json()
                })
                .then(posts => {
                    posts.map(post => post.liked_by.includes("{{user.username}}") ? post.like = false : post.like = true )
                    setData(posts)
                    props.setUpdate(true)
                    
                })
                .catch(err => {
                    setError(err.message)
                    setData(null)
                })
                return {}

            }, [props.update])

            return <div className="container-fluid"> 
                {data &&  data.map(({like, id, posted_by, content, posted_at, liked_by}) => (
                    <div className="card">
                            <div className="card-header">
                                <h5><button id="user_button" onClick={()=>props.profile(posted_by)}>{posted_by}</button></h5>
                                <div className='buttons' user="{{user.username}}">
                                    {posted_by != "{{user.username}}" && <LikeButtons id={id} liked_by={liked_by} like={like} posted_by={posted_by} setUpdate={props.setUpdate} func={changeButton}/>}
                                </div>
                                </div>
                            <div className="card-body">
                                <p className="card-text">{content}</p>
                                <WhoLiked liked_by={liked_by} />
                            </div>
                            <div className="card-footer text-muted">{posted_at}</div>
                        </div>
                    ))}
                    <Pagination fetchOn={'all_posts'} setData={setData} data={data} setError={setError} setUpdate={props.setUpdate}/>
                </div>;
        }

        function App(){
            const auth = "{{user.is_authenticated}}" === 'False' ? false : true
            const [update, setUpdate] = React.useState(null);
            const [showPosts, setShowPosts] = React.useState(false)
            const [showProfile, setShowProfile] = React.useState({})
            const [showFollowing, setShowFollowing] = React.useState(false)

            React.useEffect(()=>{
                const allPostLink = document.querySelector('#allposts')
                const userLink = document.querySelector('#user_profile')
                const followingLink = document.querySelector("#following")
                followingLink ? followingLink.addEventListener('click', () => followingView("{{user.username}}")) : null
                userLink ? userLink.addEventListener('click', () => profileView("{{user.username}}")) : null
                allPostLink ? allPostLink.addEventListener('click', ()=> postsView("{{user.username}}")) : null
            },[])


            function profileView(user){
                setShowPosts(false)
                setShowProfile({
                    isShown:true,
                    user:user
                })    
                setShowFollowing({isShown:false, user:user})
            }

            function postsView(user){
                setShowPosts(true)
                setShowProfile({isShown:false, user:user})
                setShowFollowing({isShown:false, user:user})
            }

            function followingView(user){
                setShowPosts(false)
                setShowProfile({isShown:false, user:user})
                setShowFollowing({isShown:true, user:user})
            }
            return (
                <div>       
                    {!showProfile.isShown && !showPosts && !showFollowing.isShown && <Home/>}
                    {auth && showProfile.isShown && <UserView user={showProfile.user} setUpdate={setUpdate} update={update}/>}
                    {auth && showPosts && <PostForm setUpdate={setUpdate} setShowPosts={setShowPosts}/>}
                    {showPosts && <Posts setUpdate={setUpdate} update={update} profile={profileView}/>}
                    {showFollowing.isShown && <FollowingView user={showFollowing.user} profile={profileView} setUpdate={setUpdate} update={update}/>}
                </div>
            )
        }  
        ReactDOM.render(<App />, document.querySelector("#root"));
    </script>
{% endblock %}